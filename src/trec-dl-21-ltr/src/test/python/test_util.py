from util import *
import numpy as np

def test_transformation_to_np_for_topic_1000006():
    file_name = 'src/test/java/de/webis/trec_dl_21_ltr/lightgbm/LightGBMExtractionTest.approveTestRerankFile.approved.txt'
    actual = load_ranking_data(file_name)
    
    assert 2 == len(actual)
    assert '1000006' == actual[0]['topic']
    assert ['msmarco_doc_09_1282503587', 'msmarco_doc_14_800591714'] == actual[0]['documents']
    expectedDocumentFeatures = '''[[4.0000000e+00 6.0341460e+00 9.7587550e+00 4.5531254e+00 5.5039550e+00
  3.2408369e+00 6.0053463e+00 7.6188130e+00 9.8334580e+00 2.9889687e+01
  1.0337326e+01 1.2912055e+01 1.2985181e+01 1.0177809e+01 9.9786580e+00
  1.3800000e+02 9.9158960e+00 1.9580540e+00 2.1471844e+00 3.7157185e+00
  1.0000000e+00 8.7718490e-01 3.5384357e+00 3.0264559e+00 9.1900330e+00
  1.2636860e+00 5.8667210e+00 1.0000000e+00 3.7023800e+00 1.7869432e+00
  1.5483495e+00 9.1052960e+00 3.4133742e+00 1.0757700e+00 5.5104713e+00
  3.5867143e+00 7.3000000e+01 4.0000000e+00 2.0000000e+00 2.4770000e+03
  8.0000000e+00 0.0000000e+00 0.0000000e+00 3.2983000e+04 1.0000000e+00
  9.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 1.0000000e+00]
 [0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
  0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 3.1307268e+01
  1.0284065e+01 1.2909918e+01 1.2766182e+01 1.0198633e+01 9.6068710e+00
  4.1000000e+01 9.3050950e+00 1.6801254e+00 0.0000000e+00 0.0000000e+00
  0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
  0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
  0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
  0.0000000e+00 2.7000000e+01 2.0000000e+00 1.0000000e+00 8.1800000e+02
  1.2000000e+01 2.6100000e-08 1.7220784e+07 1.6990400e+05 1.0000000e+00
  9.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 1.0000000e+00]]'''

    assert expectedDocumentFeatures == format(actual[0]['documentFeatures'])


def test_transformation_to_np_for_topic_1000412():
    file_name = 'src/test/java/de/webis/trec_dl_21_ltr/lightgbm/LightGBMExtractionTest.approveTestRerankFile.approved.txt'
    actual = load_ranking_data(file_name)
    
    assert 2 == len(actual)
    assert '1000412' == actual[1]['topic']
    assert ['msmarco_doc_21_243726663', 'msmarco_doc_21_243753677'] == actual[1]['documents']
    expectedDocumentFeatures = '''[[1.0000000e+00 5.9681030e+00 1.5417582e+01 9.9817095e+00 7.0542226e+00
  3.3183775e+00 5.8184376e+00 9.9828180e+00 1.2387515e+01 4.3853250e+01
  2.0484116e+01 2.2398296e+01 2.2988028e+01 1.9673857e+01 1.2836817e+01
  1.1700000e+02 9.9082280e+00 2.2360610e+00 0.0000000e+00 0.0000000e+00
  0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
  0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
  0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
  0.0000000e+00 4.4000000e+01 2.0000000e+00 2.0000000e+00 3.6520000e+03
  7.0000000e+00 3.8500000e-08 1.6836974e+07 1.0200000e+02 1.0000000e+00
  1.6000000e+01 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00]
 [0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
  0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 3.9118214e+01
  1.8977247e+01 2.0256464e+01 2.0428116e+01 1.8106066e+01 8.6195345e+00
  3.4000000e+01 6.3394017e+00 1.4111233e+00 0.0000000e+00 0.0000000e+00
  0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
  0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
  0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00
  0.0000000e+00 4.4000000e+01 2.0000000e+00 2.0000000e+00 3.0650000e+03
  7.0000000e+00 3.8500000e-08 1.6836974e+07 1.0200000e+02 1.0000000e+00
  1.6000000e+01 0.0000000e+00 0.0000000e+00 0.0000000e+00 0.0000000e+00]]'''

    print(format(actual[1]['documentFeatures']))
    assert expectedDocumentFeatures == format(actual[1]['documentFeatures'])


def test_creation_of_run_file():
    actual = run_file_content(
        model_file='src/test/resources/lightgbm-100-trees-50-features.txt',
        feature_file='src/test/java/de/webis/trec_dl_21_ltr/lightgbm/LightGBMExtractionTest.approveTestRerankFile.approved.txt',
        system_name='webis-test',
    )

    expected = '''1000006 Q0 msmarco_doc_09_1282503587 1 -1.8019305898994407 webis-test
1000006 Q0 msmarco_doc_14_800591714 2 -2.9864619153847776 webis-test
1000412 Q0 msmarco_doc_21_243726663 1 -1.026857537863855 webis-test
1000412 Q0 msmarco_doc_21_243753677 2 -3.413889287198377 webis-test'''

    print(actual)
    assert expected == actual


def format(arr):
    return str(np.array([i[2:] for i in arr]))
